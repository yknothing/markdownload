# 严格文件名清理模式（记录）

状态：记录建议，暂不实施

## 背景与问题

- 文件名来源广泛（标题、模板变量、域名、用户输入），可能携带：
  - 路径遍历序列：`..`、`../`、`..\`、混合 `....///`
  - URL 编码：`%2e%2e%2f` 等
  - 控制字符：`[\x00-\x1F\x7F]`
  - 路径分隔符：`/`、`\`
- 现状：
  - 已在 `generateValidFileName` 中移除 `..`、非法字符（测试环境），生产环境替换为安全字符以保留可读性。
  - 仍可能存在编码/混合序列的绕过方式；某些集成（如 Obsidian URI）对路径更敏感。

## 严格模式的思路

- 在开启时，按更严格规则清理：
  - 移除控制字符 `\x00-\x1F\x7F`
  - 移除路径遍历 `..`（包括嵌套/重复）及路径分隔符 `/`、`\\`
  - 移除 URL 编码片段 `%[0-9a-fA-F]{2}`（或先尝试 decode 再清理）
  - 保留名回退、前后导点处理、长度限制 255
- 默认关闭，避免影响可读性与兼容性；通过选项开关（如 `strictFileNameSanitize: false`）启用。

## 优缺点

- 优点：
  - 提高安全性，降低路径注入/遍历风险
  - 与部分平台/协议的约束更匹配（如 URI）
- 缺点：
  - 文件名可读性下降（过多替换/移除）
  - 与现有用户预期不一致，可能破坏历史命名规则
  - 需要更全面的测试与迁移策略

## 建议

- 短期：保持现状；记录该方案与测试用例清单（编码/混合序列/控制字符）。
- 中期：增加开关；仅在安全敏感路径（如 Obsidian URI 拼装）启用。
- 长期：视用户反馈收紧默认策略，确保有清晰的迁移文档与回退机制。

## 相关文件

- `src/background/background.js:507` (`generateValidFileName`)
- `tests/boundary/edge-cases.test.js`

